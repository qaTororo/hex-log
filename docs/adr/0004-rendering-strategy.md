# ADR-0004: レンダリング戦略

## ステータス

承認

## コンテキスト

ブログの各ページをどのタイミング・どの場所でHTMLに変換するかを決定する必要がある。この判断はパフォーマンス（Core Web Vitals目標値）、インフラ構成、開発の複雑性に直結する。

edge-caseの特性:
- コンテンツはMarkdownファイルで管理し、更新頻度は週1本以上
- 現時点の主要ページは記事一覧と記事詳細（静的コンテンツ）
- 将来的にクライアントサイド検索やTFTビジュアライザ等の動的機能を追加する可能性がある（→ ADR-0007）

## 検討した選択肢

### 1. フルSSG（Static Site Generation）

全ページをビルド時に静的HTMLとして生成する。CDNから配信。

- **メリット:**
  - パフォーマンスが最高。TTFBがCDNの応答時間のみ
  - サーバーランタイムが不要。ホスティングコストが最小
  - セキュリティリスクが低い（サーバーサイドの実行コードがない）
  - Lighthouseスコアが高くなりやすい
- **デメリット:**
  - 動的コンテンツ（検索結果、ユーザー固有コンテンツ等）に対応できない
  - 記事数が増えるとビルド時間が線形に増加する
  - 動的機能を追加する際にアーキテクチャの変更が必要になる

### 2. フルSSR（Server-Side Rendering）

全ページをリクエスト時にサーバーでHTMLを生成する。

- **メリット:**
  - 全ページが常に最新のデータを返す
  - 動的コンテンツ（検索、フィルタ等）に自然に対応できる
  - ビルド時間が記事数に依存しない
- **デメリット:**
  - リクエストごとにサーバー処理が走るため、TTFBがSSGより遅い
  - サーバーランタイムが必要。ホスティングコストが発生する
  - CDNキャッシュ戦略が複雑になる（キャッシュ無効化のタイミング）
  - ブログのように更新頻度が低い静的コンテンツに対してはオーバースペック

### 3. SPA + API

クライアントサイドでReact等のSPAを動かし、APIからデータを取得する。

- **メリット:**
  - リッチなインタラクティブUIが実現しやすい
  - フロントエンドとバックエンドの責務分離が明確
- **デメリット:**
  - 初期表示が遅い（JavaScriptのダウンロード・実行後にレンダリング）
  - SEOに不利（クローラーがJavaScript実行を必要とする）
  - Core Web Vitals目標値（LCP < 2.5s）の達成が困難
  - ブログという用途に対して複雑すぎる

### 4. ハイブリッド（SSG + SSR）

静的コンテンツはSSG、動的機能はSSR（またはクライアントサイド）で処理する。

- **メリット:**
  - 静的ページはSSGの高パフォーマンスを享受
  - 動的機能を追加する際にSSRに段階的に移行できる
  - 「まずSSGで始めて、必要になったらSSRを足す」というインクリメンタルな戦略が取れる
  - Honoのルーティングで静的/動的を切り分けられる
- **デメリット:**
  - SSGとSSRの2つの生成パスを管理する複雑性
  - ビルドパイプラインの設計が単純なSSGより複雑
  - どのページをSSG/SSRにするかの判断基準を明確にする必要がある

### 判断基準の整理

| ページ特性 | 適切な戦略 | 理由 |
|-----------|-----------|------|
| コンテンツが確定的（記事） | SSG | ビルド時に確定。CDNキャッシュが100%有効 |
| 更新頻度が低い（一覧） | SSG | 新記事追加時のビルドで十分 |
| クエリパラメータ依存（検索） | クライアントサイド or SSR | 入力によって出力が変わるため静的生成不可 |
| ユーザー操作依存（ビジュアライザ） | クライアントサイド | サーバーは不要。JSで完結 |

## 決定

**ハイブリッド（SSG + SSR）を採用する。ただし、MVP段階ではSSGのみで構築し、動的機能の追加時にSSRを導入する。**

ページごとの戦略:

| ページ | 戦略 | フェーズ |
|--------|------|---------|
| 記事詳細 | SSG | MVP |
| 記事一覧 | SSG | MVP |
| OGP画像 | ビルド時生成 | MVP |
| 検索 | クライアントサイド | Should/Could |
| TFTビジュアライザ | クライアントサイド | Could |

## 結果

- MVP段階ではフルSSGと実質同じ。静的HTMLをCDN配信するシンプルな構成からスタートする
- ビルドスクリプトでMarkdown→HTML変換を行い、`dist/` に静的ファイルを出力する
- Core Web Vitals目標値（LCP < 2.5s, Lighthouse >= 90）はSSGにより高い確率で達成可能
- 将来の動的機能追加時にアーキテクチャを変更する必要がない。Honoのルーティングに動的ルートを追加するだけで対応できる
- 「まずSSGで動くものを作り、必要に応じて拡張する」というYAGNI原則に沿った判断
