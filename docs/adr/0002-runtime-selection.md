# ADR-0002: ランタイム選定

## ステータス

承認

## コンテキスト

TypeScriptプロジェクトの実行ランタイムを選定する必要がある。フレームワークとしてHonoを採用済み（→ ADR-0001）であり、Honoのマルチランタイム対応を活かせる選択肢から選ぶ。

ランタイムの選定はテストランナー、パッケージマネージャ、ビルドツールの選択にも波及するため、DX全体に影響する判断となる。

## 検討した選択肢

### 1. Node.js

JavaScriptランタイムの事実上の標準。最大のエコシステムと互換性。

- **メリット:**
  - npm/yarnエコシステムとの100%互換。ほぼ全てのライブラリが動作する
  - 本番運用実績が最も豊富。トラブルシューティングの情報が充実
  - LTS（Long Term Support）による安定したリリースサイクル
  - CI環境（GitHub Actions等）でのサポートが最も成熟
- **デメリット:**
  - TypeScript実行に追加のトランスパイラ（ts-node, tsx等）が必要
  - パッケージマネージャ（npm/yarn/pnpm）、テストランナー（Jest/Vitest）、バンドラ（webpack/Vite/esbuild）を個別に選定・設定する必要がある
  - `node_modules` の容量問題とインストール速度の遅さ
  - 業務で日常的に使用しているため、学習価値が相対的に低い

### 2. Deno

Node.jsの設計上の反省を踏まえて作られたランタイム。TypeScriptをネイティブ実行。

- **メリット:**
  - TypeScriptをトランスパイラなしでネイティブ実行
  - セキュリティサンドボックス（ファイル/ネットワークアクセスの明示的許可）
  - Web標準API準拠（fetch, URL等がグローバルに利用可能）
  - 標準ライブラリが充実。テストランナー（`deno test`）内蔵
  - import mapによるパッケージ管理（node_modules不要）
- **デメリット:**
  - npm互換性が改善されてきたが、一部のライブラリ（特にnative addon依存）が動作しない
  - Hono + Viteの開発サーバー統合（@hono/vite-dev-server）がNode.js/Bun前提で作られている
  - 採用企業が限定的で、トラブル時の情報が少ない

### 3. Bun

バンドラ・テストランナー・パッケージマネージャを内蔵するオールインワンランタイム。JavaScriptCoreエンジン（Safari）ベース。

- **メリット:**
  - TypeScriptをネイティブ実行。トランスパイラ設定不要
  - パッケージマネージャ内蔵（`bun install`）。npm互換で既存のpackage.json/lockfileをそのまま使える
  - テストランナー内蔵（`bun:test`）。Jest互換APIで学習コスト低
  - `bun install` のインストール速度がnpm/yarn/pnpmより大幅に速い
  - Node.js互換APIを提供。大半のnpmパッケージがそのまま動作する
  - Honoの開発サーバー（@hono/vite-dev-server）がBunで動作確認済み
- **デメリット:**
  - Node.jsとの互換性は100%ではない。一部のnative addon、低レベルAPI（`vm`モジュール等）が未対応
  - V8ではなくJavaScriptCoreエンジンのため、Node.jsとは異なる挙動が稀に発生する可能性
  - 本番運用の実績がNode.jsより少ない。安定性のリスク
  - Windows対応が発展途上（WSL2経由での利用は可能）

### 比較軸

| 観点 | Node.js | Deno | Bun |
|------|---------|------|-----|
| TS実行 | 要トランスパイラ | ネイティブ | ネイティブ |
| テストランナー | 外部（Jest/Vitest） | 内蔵 | 内蔵（Jest互換） |
| パッケージマネージャ | 外部（npm/yarn/pnpm） | 内蔵（npm互換あり） | 内蔵（npm互換） |
| npm互換性 | 100% | 90%+ | 95%+ |
| 起動速度 | 普通 | 速い | 非常に速い |
| Hono + Vite統合 | ○ | △ | ○ |
| 学習価値 | 低（業務で使用中） | 高 | 高 |

## 決定

**Bunを採用する。**

## 結果

- TypeScript実行、テストランナー、パッケージマネージャがBun一つで完結する。ツールチェーンの設定コストが大幅に削減される
- `bun:test` をテストフレームワークとして使用する（→ テスト戦略に影響）
- npm互換のため、unified/remark/rehype等の既存エコシステムをそのまま利用できる
- @hono/vite-dev-serverとの統合が動作確認済みのため、開発サーバーの構築がスムーズ
- Node.jsとの非互換が発生した場合はNode.jsへのフォールバックが可能（Honoのマルチランタイム対応による）
- WSL2環境での開発を前提とする（Windows直接実行は対象外）
